include:
  - project: reductech/templates/cicd/dotnet
    file: .gitlab-ci.windows.yml

stages:
  - build
  - test
  - integration
  - quality
  - package
  - sign
  - push

workflow:
  rules:
    - if: $CI_COMMIT_BRANCH == 'master'
    - if: $CI_MERGE_REQUEST_ID
    - if: $CI_COMMIT_BRANCH !~ /^\d+-/
    - if: $CI_COMMIT_TAG
    - if: $CI_PIPELINE_SOURCE == 'schedule'

variables:
  PACKAGE_NAME_NUGET: Reductech.EDR.Connectors.Nuix
  PACKAGE_NAME_DLL: Reductech.EDR.Connectors.Nuix
  GIT_SUBMODULE_STRATEGY: normal

.get_coverage:
  - &get_coverage |
    $report = Get-Content -Path "*/coverage.cobertura.xml" -Raw ;
    $fixPaths = $report -replace "filename=`".+?${env:CI_PROJECT_NAME}(/|\\)", "filename=`"" ;
    [System.IO.File]::WriteAllText("./coverage.cobertura.xml", $fixPaths) ;
    $xml = [xml]$report ;
    $branchCoverage = [double]($xml.coverage."branch-rate") * 100 ;
    $lineCoverage = [double]($xml.coverage."line-rate") * 100 ;
    Write-Host "Coverage (Branch) : ${branchCoverage}%" ;
    Write-Host "Coverage (Line)   : ${lineCoverage}%"

test dev:
  script:
    - dotnet test --no-build --configuration $CONFIG -v normal
      --filter "Category!=Integration&Category!=IntegrationShort"
      --collect:"XPlat Code Coverage" --settings coverlet.runsettings --results-directory ./
    - *get_coverage

integration test:
  stage: integration
  extends:
    - .default_before_script
  needs: []
  tags:
    - nuix
  variables:
    CONFIG: $CONFIG_DEV
    NUGET_PROJECT_ID: $NUGET_PROJECT_ID_DEV
    NUGET_USERNAME: $NUGET_USER_DEV
    NUGET_TOKEN: $NUGET_TOKEN_DEV
  after_script:
    - dotnet nuget remove source reductech
  script:
    - dotnet restore --packages ./packages
    - dotnet test --no-restore --configuration $CONFIG -v normal
      --filter "Category=IntegrationShort"
      --collect:"XPlat Code Coverage" --settings coverlet.runsettings --results-directory ./
    - *get_coverage
  coverage: /Coverage \(Branch\)[\s:]+(\d+.?\d*)%/
  artifacts:
    reports:
      cobertura: coverage.cobertura.xml
  rules:
    - if: $CI_COMMIT_BRANCH == 'master'
    - if: &not_release $CI_COMMIT_TAG !~ /^v(0|[1-9]\d*)\.(0|[1-9]\d*)\.(0|[1-9]\d*)(?:-((?:0|[1-9]\d*|\d*[a-zA-Z-][0-9a-zA-Z-]*)(?:\.(?:0|[1-9]\d*|\d*[a-zA-Z-][0-9a-zA-Z-]*))*))?$/i
      when: manual
      allow_failure: true

integration full:
  extends:
    - integration test
  script:
    - dotnet restore --packages ./packages
    - dotnet test --no-restore --configuration $CONFIG -v normal
      --filter "Category=Integration"
      --collect:"XPlat Code Coverage" --settings coverlet.runsettings --results-directory ./
    - *get_coverage
    - |
      dotnet test --no-restore --configuration $CONFIG --list-tests |
        ForEach-Object {
          if ($_ -match 'caseName: "(.+?)\((\d+\.\d+)\)') {
            [pscustomobject]@{ Name = $Matches[1] ; Version = $Matches[2] }
        } } | group Version | select Name, Count
  rules:
    - if: $CI_PIPELINE_SOURCE == 'schedule'

integration test release:
  extends:
    - integration test
    - .rules_release
  variables:
    CONFIG: $CONFIG_RELEASE
    NUGET_PROJECT_ID: $NUGET_PROJECT_ID_RELEASE
    NUGET_USERNAME: $NUGET_USER_PROD
    NUGET_TOKEN: $NUGET_TOKEN_PROD

push to nuget dev:
  rules:
    - if: $CI_PIPELINE_SOURCE == 'schedule'
      when: never
    - if: $CI_COMMIT_BRANCH == 'master'
    - if: *not_release
      when: manual
      allow_failure: true

# Skipping mutation testing as Stryker currently doesn't support filters
mutation testing:
  rules:
    - when: never
